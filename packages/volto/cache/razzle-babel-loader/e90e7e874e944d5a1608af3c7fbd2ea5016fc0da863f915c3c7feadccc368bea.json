{"ast":null,"code":"/**\n * Sitemap helper.\n * @module helpers/Sitemap\n */\n\nimport superagent from 'superagent';\nimport map from 'lodash/map';\nimport zlib from 'zlib';\nimport { toPublicURL } from '@plone/volto/helpers/Url/Url';\nimport { addHeadersFactory } from '@plone/volto/helpers/Proxy/Proxy';\nimport config from '@plone/volto/registry';\nexport const SITEMAP_BATCH_SIZE = 5000;\n\n/**\n * Generate sitemap\n * @function generateSitemap\n * @param {Object} _req Request object\n * @return {string} Generated sitemap\n */\nexport const generateSitemap = (_req, start = 0, size = undefined) => new Promise(resolve => {\n  var _settings$internalApi;\n  const {\n    settings\n  } = config;\n  const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n  const apiPath = (_settings$internalApi = settings.internalApiPath) !== null && _settings$internalApi !== void 0 ? _settings$internalApi : settings.apiPath;\n  const request = superagent.get(`${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_start=${start}&b_size=${size !== undefined ? size : 100000000}&use_site_search_settings=1`);\n  request.set('Accept', 'application/json');\n  request.use(addHeadersFactory(_req));\n  const authToken = _req.universalCookies.get('auth_token');\n  if (authToken) {\n    request.set('Authorization', `Bearer ${authToken}`);\n  }\n  request.end((error, {\n    body\n  } = {}) => {\n    if (error) {\n      resolve(body || error);\n    } else {\n      const items = map(body.items, item => `  <url>\\n    <loc>${toPublicURL(item['@id'])}</loc>\\n\n            <lastmod>${item.modified}</lastmod>\\n  </url>`);\n      const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">\\n${items.join('\\n')}\\n</urlset>`;\n      zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n        resolve(buffer);\n      });\n    }\n  });\n});\n\n/**\n * Generate sitemap\n * @function generateSitemapIndex\n * @param {Object} _req Request object\n * @return {string} Generated sitemap index\n */\nexport const generateSitemapIndex = (_req, gzip = false) => new Promise(resolve => {\n  var _settings$internalApi2;\n  const {\n    settings\n  } = config;\n  const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n  const apiPath = (_settings$internalApi2 = settings.internalApiPath) !== null && _settings$internalApi2 !== void 0 ? _settings$internalApi2 : settings.apiPath;\n  const request = superagent.get(`${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_size=0&use_site_search_settings=1`);\n  request.set('Accept', 'application/json');\n  const authToken = _req.universalCookies.get('auth_token');\n  if (authToken) {\n    request.set('Authorization', `Bearer ${authToken}`);\n  }\n  request.end((error, {\n    body\n  } = {}) => {\n    if (error) {\n      resolve(body || error);\n    } else {\n      const items = Array.from({\n        length: Math.ceil(body.items_total / SITEMAP_BATCH_SIZE)\n      }, (_, i) => `  <sitemap>\n    <loc>${toPublicURL('/sitemap' + (i + 1) + '.xml.gz')}</loc>\n  </sitemap>`);\n      const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n${items.join('\\n')}\\n</sitemapindex>`;\n      if (gzip) {\n        zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n          resolve(buffer);\n        });\n      } else {\n        resolve(result);\n      }\n    }\n  });\n});","map":{"version":3,"names":["superagent","map","zlib","toPublicURL","addHeadersFactory","config","SITEMAP_BATCH_SIZE","generateSitemap","_req","start","size","undefined","Promise","resolve","_settings$internalApi","settings","APISUFIX","legacyTraverse","apiPath","internalApiPath","request","get","set","use","authToken","universalCookies","end","error","body","items","item","modified","result","join","gzip","Buffer","from","_err","buffer","generateSitemapIndex","_settings$internalApi2","Array","length","Math","ceil","items_total","_","i"],"sources":["/Users/varshanmaji/Projects/volto/packages/volto/src/helpers/Sitemap/Sitemap.js"],"sourcesContent":["/**\n * Sitemap helper.\n * @module helpers/Sitemap\n */\n\nimport superagent from 'superagent';\nimport map from 'lodash/map';\nimport zlib from 'zlib';\nimport { toPublicURL } from '@plone/volto/helpers/Url/Url';\nimport { addHeadersFactory } from '@plone/volto/helpers/Proxy/Proxy';\n\nimport config from '@plone/volto/registry';\n\nexport const SITEMAP_BATCH_SIZE = 5000;\n\n/**\n * Generate sitemap\n * @function generateSitemap\n * @param {Object} _req Request object\n * @return {string} Generated sitemap\n */\nexport const generateSitemap = (_req, start = 0, size = undefined) =>\n  new Promise((resolve) => {\n    const { settings } = config;\n    const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n    const apiPath = settings.internalApiPath ?? settings.apiPath;\n    const request = superagent.get(\n      `${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_start=${start}&b_size=${\n        size !== undefined ? size : 100000000\n      }&use_site_search_settings=1`,\n    );\n    request.set('Accept', 'application/json');\n    request.use(addHeadersFactory(_req));\n    const authToken = _req.universalCookies.get('auth_token');\n    if (authToken) {\n      request.set('Authorization', `Bearer ${authToken}`);\n    }\n    request.end((error, { body } = {}) => {\n      if (error) {\n        resolve(body || error);\n      } else {\n        const items = map(\n          body.items,\n          (item) =>\n            `  <url>\\n    <loc>${toPublicURL(item['@id'])}</loc>\\n\n            <lastmod>${item.modified}</lastmod>\\n  </url>`,\n        );\n        const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd\">\\n${items.join(\n          '\\n',\n        )}\\n</urlset>`;\n        zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n          resolve(buffer);\n        });\n      }\n    });\n  });\n\n/**\n * Generate sitemap\n * @function generateSitemapIndex\n * @param {Object} _req Request object\n * @return {string} Generated sitemap index\n */\nexport const generateSitemapIndex = (_req, gzip = false) =>\n  new Promise((resolve) => {\n    const { settings } = config;\n    const APISUFIX = settings.legacyTraverse ? '' : '/++api++';\n    const apiPath = settings.internalApiPath ?? settings.apiPath;\n    const request = superagent.get(\n      `${apiPath}${APISUFIX}/@search?metadata_fields=modified&b_size=0&use_site_search_settings=1`,\n    );\n    request.set('Accept', 'application/json');\n    const authToken = _req.universalCookies.get('auth_token');\n    if (authToken) {\n      request.set('Authorization', `Bearer ${authToken}`);\n    }\n    request.end((error, { body } = {}) => {\n      if (error) {\n        resolve(body || error);\n      } else {\n        const items = Array.from(\n          { length: Math.ceil(body.items_total / SITEMAP_BATCH_SIZE) },\n          (_, i) =>\n            `  <sitemap>\n    <loc>${toPublicURL('/sitemap' + (i + 1) + '.xml.gz')}</loc>\n  </sitemap>`,\n        );\n        const result = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n${items.join('\\n')}\\n</sitemapindex>`;\n\n        if (gzip) {\n          zlib.gzip(Buffer.from(result, 'utf8'), (_err, buffer) => {\n            resolve(buffer);\n          });\n        } else {\n          resolve(result);\n        }\n      }\n    });\n  });\n"],"mappings":"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","ignoreList":[]},"metadata":{"react-intl":{"messages":[]}},"sourceType":"module","externalDependencies":[]}